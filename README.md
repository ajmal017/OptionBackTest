# OptionBackTest
__from for/if/else to my first option back-test function__  
  
#### 写在前面的话
其实是上学期（大四上）在实习的时候有写过一个卖期权的策略（后来还成了我的毕业论文），
那时候就觉得期权回测好难写啊，一堆问题要考虑……然后就东部西凑终于把这个策略给写出来了，
按照我发小（肖B）的话说就是：  
<p align="center">
“在垃圾堆上扔垃圾……”
</p>
结果这次疫情在家，就觉得必须得把所有的东西都整理一遍（因为我强迫症老是发作，浑身难受……），
不能老像个垃圾场……而且这个策略的回测函数完全没有可延展性（就是说只能用在这个策略上，换一个就不行了……）。
所以我决定了，要自己写一个回测函数，想想也挺简单的，不就一个for循环嘛，到点了开仓，到期了平仓换月，
轻轻松松就能搞定……但是直到我写完我才意识到，这是真的不容易呀……  
  
#### 输入与输出
动笔之前，我们最先应该明确的就是，我们需要什么？
我们已经知道，我们的回测函数大概是一个for循环，到点了自动开平仓，
所以每天都要有一个if语句来判断说今天的程序到底应该执行什么样的操作：  
  
```Python
if 开仓:
  空头 or 多头:
    看涨 or 看跌 or 双边:
      保证金 or 期权费 or 手续费
elif 不操作:
  空头:
    计算收益
    保证金是否满足
  多头:
    计算收益
  *是否加减仓:
elif 平仓:
  计算收益
  手续费
```
  
所以我们知道，我们要有：1. 判断开平仓；2. 判断多空头；3. 判断看涨看跌；共3个信号变量，
还要有看涨看跌期权每日的保证金，共5个变量。如果考虑加减仓的话，又要多一个信号变量。
除此之外，你可能还想设置每次开仓、加减仓的仓位大小，又要再多两个变量……（算了我还是直接放输入端的DataFrame格式吧……）：  
  
```Python
def OptionBT(signalDf,depositDf,Capital=1000000,pct=0.8,Fee=2.5,Rde=0.2,Point=10000):
    
    # input:
    # signalDf[DataFrame]: [trade_date, Call_close, Put_close, Call_volume, Put_volume, signal, direction, position, pct]
    # -- signal[int]: -2: 空头平仓, -1: 多头平仓, 0: 不操作, 1: 多头开仓, 2: 空头开仓
    # -- direction[int]: 0: Put, 1: Call, 2: 双边
    # -- position[int]: -1: 减仓, 0: 不操作, 1: 加仓
    # -- pct[float]: 加仓或减仓的比例，仓位变更数量为pct*volume
```
  
除此之外，还有一些回测的基本参数需要设定，也算作是输入值：  
  
Capital本金、pct开仓百分比、Fee手续费、Rde保证金上浮比率、Point期权价格点位比例  
  
输出就很简单啦。可以自己定义自己想输出的值：  
  
recordDf: [trade_date日期, profit每日收益, deposit保证金账户, signal开平仓信号,   
position多空头, direction看涨/看跌/双边, log交易日志, volume成交量,   
turnover成交额, fee手续费, opfee期权费, capital本金, strategy策略收益]  
  
总共13个需要输出的变量，所以我们就需要在for循环的底端，每次都对这13个list append当天的值，而每天的值，
都会因今天的开平仓状态不同而有所变化。如，今天是平仓，记得将所有的变量都恢复为初始值，否则下一天不操作的话，
数据会继承前一天的值，未清零的值会让本不该进行任何操作的今天进行错误的操作
（好吧我知道说得有点绕，下面讲计算每日收益的时候会解释为什么必须这么做……）。  
  
#### 每日收益的计算
说实话我一开始也很懵期权每日收益的计算（喵的一张几毛钱为啥会有那么大的收益波动？哦原来我忘记乘点数一万了……）。简单来讲就是：  
<p align="center">
（Callt – Callt-1）×Volume×Point
</p>
是的就是这么简单，但是你需要思考一个问题：连续两天的收益=第一天收益+第二天的收益？  
答案是否定的，什么时候才成立呢？当你每天都开盘开仓、收盘平仓时，连续两天的收益才会等于两天各自的收益相加。
而你交易期权或者是股票，是买入并持有，即便在你平仓以前它可能会跌到你连裤衩都不剩，但只要你打死都不卖掉，它就不会成为你的损失……  
但这部分损失不能就这么算了呀，会出现这种情况还是你的决策失误，我们算策略的累计收益曲线就是要假设每一天都平仓了，
算要是我今天就把期权或者是股票给卖了了，我能赚多少钱（写到这里，我才发现，我又忘记算手续费了……淦……）？  
所以你还需要一个额外的list来记录你开仓时的期权价格Call0，而正确的每日收益计算公式应该是：  
<p align="center">
（Callt – Call0）×Volume×Point
</p>
来填补上一节最后留下来的坑了，为什么平仓的时候要把所有变量都恢复初始值：  
看上面的每日收益计算公式，今天的收益要怎么算，取决于你之前开的仓位是多头还是空头，
是交易看涨期权、看跌期权还是双边交易。所以相当于是，不操作的每一天，你都要继承前一天的数据，
即list.append(list[-1])，这样才能继承到你上一次开仓时的信息，才能知道你开的是啥子仓？今天的收益该怎么算？  
如果你平仓后没有恢复初始值的话，第二天又恰好是不操作，它将继承你上一次开仓的信息，
也就是你昨天已经平掉了的仓位信息，继续计算收益！而其实今天的收益应该是0，因为你平仓后又还没有开仓，
所以需要对所有的变量进行初始值的恢复，相当于是洗掉上一次开仓时的数据，
告诉未来：“我已经准备好了，可以给我新的仓位数据了。在那之前，我将保持没有仓位信息的初始值状态！”  
  
  
